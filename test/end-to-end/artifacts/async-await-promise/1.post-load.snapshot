export 0 = &function run;

slot ['global:Promise'] = &allocation 5;
slot ['global:assert'] = host function 2;
slot ['global:asyncTestComplete'] = host function 6;
slot myAsyncFunc = &function myAsyncFunc;
slot runAsync = &function runAsync;
slot test_asyncReturnsPromise = &function test_asyncReturnsPromise;

function asyncCatchBlock() {
  entry:
    Literal(lit false);
    AsyncComplete();
}

function asyncContinue() {
  entry:
    LoadScoped(index 1);
    Literal(lit undefined);
    LoadScoped(index 2);
    LoadScoped(index 3);
    Call(count 3, flag false);
    Return();
}

function asyncHostCallback() {
  entry:
    Literal(lit undefined);
    LoadArg(index 2);
    LoadArg(index 1);
    AsyncComplete();
}

function myAsyncFunc() {
  entry:
    AsyncStart(count 2, flag false);
    Literal(lit undefined);
    AsyncReturn();
}

function run() {
  entry:
    // Void-call async function
    LoadGlobal(name 'runAsync');
    Literal(lit undefined);
    Call(count 1, flag true);
    Literal(lit undefined);
    Return();
}

function runAsync() {
  entry:
    AsyncStart(count 2, flag false);
    StartTry(@block1);
    LoadGlobal(name 'test_asyncReturnsPromise');
    Literal(lit undefined);
    Call(count 1, flag true);
    LoadGlobal(name 'global:asyncTestComplete');
    Literal(lit undefined);
    Literal(lit true);
    Literal(lit undefined);
    Call(count 3, flag true);
    EndTry();
    Jump(@block2);
  block1:
    LoadGlobal(name 'global:asyncTestComplete');
    Literal(lit undefined);
    Literal(lit false);
    LoadVar(index 3);
    Call(count 3, flag true);
    Pop(count 1);
    Jump(@block2);
  block2:
    Literal(lit undefined);
    AsyncReturn();
}

function test_asyncReturnsPromise() {
  entry:
    Literal(lit deleted);
    LoadGlobal(name 'myAsyncFunc');
    Literal(lit undefined);
    Call(count 1, flag false);
    StoreVar(index 0);
    LoadGlobal(name 'global:assert');
    Literal(lit undefined);
    LoadVar(index 0);
    Literal(lit '__proto__');
    ObjectGet();
    LoadGlobal(name 'global:Promise');
    Literal(lit 'prototype');
    ObjectGet();
    BinOp(op '===');
    Call(count 2, flag true);
    Pop(count 1);
    Literal(lit undefined);
    Return();
}

allocation 5 = {
  prototype: &allocation 6,
};

allocation 6 = {
};